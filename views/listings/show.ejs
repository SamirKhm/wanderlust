<%- layout("/layouts/boilerplate.ejs")%>

<style>
  /* your styles here */
  .custom-card {
  width: 70%;
  margin: auto;
  border: none;
  border-radius: 1.5rem;
  background-color: #fefefe;
}

.custom-card .list-group-item {
  font-size: 1.1rem;
  background-color: transparent;
  border: none;
  padding: 0.75rem 1.25rem;
}

.btn {
  border-radius: 1rem;
}

.btn-primary {
  background-color: #007bff;
  border-color: #007bff;
}

.btn-danger {
  background-color: #dc3545;
  border-color: #dc3545;

}
.img-fluid{
  height: 250px;
  object-fit: cover;
  width: 90%;
}



.show-img {
  text-align: center;
}
</style>
<body>
<div class="container mt-5 mb-5">
  <div class="card shadow-lg rounded-4 custom-card">
    <div class="card-body">
      <!-- Listing details -->
      <h3 class="card-title mb-4 text-center">Listing Details</h3>
      <div class="show-img">
        <img src="<%= listing.image.url %>" class="img-fluid rounded-4" alt="Listing Image">
        <p class="owner-name">Owned by : <%=listing.owner.username%></p>
      </div>
      <ul class="list-group list-group-flush mb-4">
        <li class="list-group-item"><strong>Title:</strong> <%= listing.title %></li>
        <li class="list-group-item"><strong>Description:</strong> <%= listing.description %></li>
        <li class="list-group-item">
  <strong>Price:</strong>
  <% if (listing.price != null) { %>
    â‚¹<%= listing.price.toLocaleString("en-IN") %>
  <% } else { %>
    <i>Not specified</i>
  <% } %>
</li>

        <li class="list-group-item"><strong>Location:</strong> <%= listing.location %></li>
        <li class="list-group-item"><strong>Country:</strong> <%= listing.country %></li>
      </ul>

      <% if(currUser && listing.owner._id.equals(currUser._id)) {%>
        <div class="d-flex justify-content-between p-3 ">
        <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary px-4">
          Edit Listing
        </a>
        <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="d-inline">
          <button type="submit" class="btn btn-danger px-4">Delete Listing</button>
        </form>
      </div>
      <%}%>
    </div>
  </div>
<div class="row">
      <div class="col-md-8 offset-md-2 mt-4 mb-3">
        <!-- Review form -->
      <%if(currUser){ %>
      <h4 class="mb-3">Leave a Review</h4>
    <form method="POST" action="/listings/<%= listing._id %>/reviews" class="needs-validation" novalidate>
      <div>
        <fieldset class="starability-slot">
  <legend>First rating:</legend>

  <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />
  
  <input type="radio" id="first-rate1" name="review[rating]" value="1" />
  <label for="first-rate1" title="Terrible">1 star</label>

  <input type="radio" id="first-rate2" name="review[rating]" value="2" />
  <label for="first-rate2" title="Not good">2 stars</label>

  <input type="radio" id="first-rate3" name="review[rating]" value="3" />
  <label for="first-rate3" title="Average">3 stars</label>

  <input type="radio" id="first-rate4" name="review[rating]" value="4" />
  <label for="first-rate4" title="Very good">4 stars</label>

  <input type="radio" id="first-rate5" name="review[rating]" value="5" />
  <label for="first-rate5" title="Amazing">5 stars</label>
</fieldset>

      </div>
      
      <div class="mb-3">
        <label for="comment" class="form-label">Comment</label>
        <textarea class="form-control" id="comment" name="review[comment]" rows="4" required></textarea>
      </div>
      <div class="text-center">
        <button type="submit" class="btn btn-primary px-4">Submit Review</button>
      </div>
    </form>
  <% } %>
  </div>
    </div>
  

  <hr>

  
<div class="px-4 pb-4">
  <h4>All Reviews</h4>

  <% if (listing.reviews && listing.reviews.length > 0) { %>
    <div class="row row-cols-1 row-cols-md-2 g-4">
c       <% listing.reviews.forEach((review) => { %>
        <div class="col">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <h5 class="card-title">By <%= review.author.username %></h5>
              <div class="starability-result card-text" data-rating="<%= review.rating %>"></div>
              <p class="card-text"><strong>Comment:</strong> <%= review.comment %></p>
            </div>
            <% if (currUser && String(review.author._id) === String(currUser._id)) { %>
              <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST">
                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
              </form>
            <% } %>
          </div>
        </div>
      <% }); %>
    </div>
  <% } else { %>
    <p class="text-muted">No reviews yet.</p>
  <% } %>
</div>


 <div class="row">
  <div class="col-8 offset-3 mb-3">
    <h3>Where you'll be</h3>
    <div id="map"></div>
  </div>
</div>

  


</div>

<script>

window.mapToken = "<%= process.env.MAP_TOKEN %>";
window.coordinates = JSON.parse("<%- JSON.stringify(listing.geometry.coordinates) %>");
console.log("Token:", window.mapToken);
console.log("Coordinates:", window.coordinates);


mapboxgl.accessToken = window.mapToken;

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: window.coordinates,
    zoom: 10.8
});


new mapboxgl.Marker({color:"red"})
    .setLngLat(window.coordinates)
    .setPopup(new mapboxgl.Popup()
    .setHTML("<p>Exact location provided after booking</p>"))
    .addTo(map);




</script>

</body>